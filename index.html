<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مواقف برج مجدول - iOS 18</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #f2f2f7;
            --card-bg: rgba(255, 255, 255, 0.75);
            --text-color: #000000;
            --accent: #007aff;
            --glass-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(120, 120, 128, 0.12);
        }

        body.dark {
            --bg-color: #000000;
            --card-bg: rgba(28, 28, 30, 0.8);
            --text-color: #ffffff;
            --accent: #0a84ff;
            --glass-border: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(120, 120, 128, 0.25);
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.4s ease;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .liquid-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
            background: radial-gradient(circle at 10% 20%, rgba(0, 122, 255, 0.1), transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(88, 86, 214, 0.1), transparent 40%);
        }

        .page { width: 100%; max-width: 480px; }

        header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 15px 20px;
            border-bottom: 0.5px solid var(--glass-border);
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }

        .header-logos img { height: 35px; border-radius: 8px; }
        .nav-icons { display: flex; gap: 18px; }
        .icon-btn { font-size: 20px; color: var(--accent); cursor: pointer; }

        .container { padding: 15px; }

        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 0.5px solid var(--glass-border);
            border-radius: 22px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        }

        h2 { font-size: 18px; margin: 0 0 15px 0; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        input, select {
            width: 100%; padding: 14px; border-radius: 12px; border: none;
            background: var(--input-bg); color: var(--text-color);
            font-size: 16px; margin-bottom: 12px; box-sizing: border-box; outline: none;
        }

        .search-results {
            max-height: 250px; overflow-y: auto; margin-top: -5px; border-radius: 12px;
        }

        .result-item {
            padding: 12px; border-bottom: 0.5px solid var(--glass-border); cursor: pointer;
            transition: 0.2s;
        }
        .result-item:active { background: var(--input-bg); }
        .result-item div { font-size: 13px; opacity: 0.7; }
        .result-item strong { color: var(--accent); font-size: 15px; }

        .btn-primary {
            width: 100%; padding: 16px; background: var(--accent); color: white;
            border: none; border-radius: 14px; font-size: 17px; font-weight: 600; cursor: pointer;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .stat-box { background: var(--input-bg); padding: 12px; border-radius: 15px; text-align: center; }
        .stat-box small { font-size: 10px; display: block; margin-bottom: 4px; }
        .stat-box span { font-size: 18px; font-weight: bold; }

        footer { text-align: center; padding: 30px; font-size: 12px; opacity: 0.5; }
    </style>
</head>
<body class="dark">

    <div class="liquid-bg"></div>

    <div class="page">
        <header>
            <img src="Majdoul.png" alt="Tower" onerror="this.style.visibility='hidden'">
            <div class="nav-icons">
                <i class="fas fa-adjust icon-btn" onclick="toggleTheme()"></i>
                <i class="fas fa-chart-pie icon-btn" onclick="toggleView()"></i>
            </div>
            <img src="linkexpert.png" alt="LinkExpert" onerror="this.style.visibility='hidden'">
        </header>

        <main class="container">
            
            <div id="entryView">
                <div class="glass-card">
                    <h2><i class="fas fa-search"></i> نظام البحث الذكي</h2>
                    <input type="text" id="globalSearch" placeholder="بحث (لوحة، موظف، شركة، لون...)" oninput="handleGlobalSearch()">
                    <div id="searchResults" class="search-results"></div>
                </div>

                <div class="glass-card">
                    <h2><i class="fas fa-car"></i> تفاصيل الموقف</h2>
                    <label style="font-size: 12px; opacity: 0.6;">المركبة المختارة</label>
                    <input type="text" id="targetPlate" readonly placeholder="اختر من نتائج البحث">
                    
                    <div style="display: flex; gap: 10px;">
                        <div style="flex: 2;">
                            <label style="font-size: 12px; opacity: 0.6;">الوحدة (Unite)</label>
                            <select id="unitSelect">
                                <option value="P1">P1</option>
                                <option value="P1-VIP">P1 - VIP</option>
                                <option value="P2">P2</option>
                                <option value="P3">P3</option>
                                <option value="P4">P4</option>
                                <option value="Landscape">Landscape</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 12px; opacity: 0.6;">رقم الموقف</label>
                            <input type="number" id="slotNumber" placeholder="Slot">
                        </div>
                    </div>

                    <button class="btn-primary" onclick="submitEntry()">تسجيل الدخول</button>
                </div>
            </div>

            <div id="statsView" style="display:none;">
                <div id="exportArea">
                    <div class="glass-card">
                        <h2>إحصائيات الشركات اليوم</h2>
                        <canvas id="companyChart" style="max-height: 220px;"></canvas>
                    </div>

                    <div class="glass-card">
                        <h2>توزيع مواقف الأدوار</h2>
                        <div id="parkingStats" class="stats-grid"></div>
                    </div>
                </div>
                
                <button class="btn-primary" style="background: #34c759;" onclick="exportReport()">
                    <i class="fas fa-download"></i> تصدير التقرير كصورة
                </button>
            </div>

        </main>

        <footer>
            الموقع: برج مجدول <br>
            بواسطة: <b>خبير الربط - Link Expert</b>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let carsData = [];
        let dailyEntries = [];
        let chartInstance = null;

        // Load data.csv and parse all 6 columns
        async function loadCSV() {
            try {
                const response = await fetch('data.csv');
                const text = await response.text();
                const rows = text.split('\n').filter(row => row.trim() !== '');
                
                // Assumes Header order: Client, Plate, Model, Color, Employee Name, Status
                carsData = rows.slice(1).map(row => {
                    const cols = row.split(',').map(c => c.trim());
                    return {
                        client: cols[0] || '',
                        plate: cols[1] || '',
                        model: cols[2] || '',
                        color: cols[3] || '',
                        employee: cols[4] || '',
                        status: cols[5] || ''
                    };
                });
                console.log("Data loaded: " + carsData.length + " cars.");
            } catch (e) {
                console.error("CSV loading failed. Check if data.csv exists.");
            }
        }

        // Global Search Functionality (Searches all columns)
        function handleGlobalSearch() {
            const query = document.getElementById('globalSearch').value.toLowerCase();
            const resultsBox = document.getElementById('searchResults');
            resultsBox.innerHTML = '';

            if (query.length < 2) return;

            // Search across all fields
            const matches = carsData.filter(c => 
                c.plate.toLowerCase().includes(query) ||
                c.employee.toLowerCase().includes(query) ||
                c.client.toLowerCase().includes(query) ||
                c.model.toLowerCase().includes(query) ||
                c.color.toLowerCase().includes(query) ||
                c.status.toLowerCase().includes(query)
            ).slice(0, 10);

            matches.forEach(car => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <strong>${car.plate}</strong> | ${car.client}
                    <div>${car.employee} - ${car.model} (${car.color})</div>
                    <div style="color: ${car.status.includes('Active') || car.status.includes('نشط') ? '#34c759' : '#ff3b30'}">
                        ● ${car.status}
                    </div>
                `;
                div.onclick = () => selectCar(car);
                resultsBox.appendChild(div);
            });
        }

        function selectCar(car) {
            document.getElementById('targetPlate').value = car.plate;
            document.getElementById('targetPlate').dataset.client = car.client;
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('globalSearch').value = '';
        }

        function submitEntry() {
            const plate = document.getElementById('targetPlate').value;
            const client = document.getElementById('targetPlate').dataset.client;
            const unit = document.getElementById('unitSelect').value;
            const slot = document.getElementById('slotNumber').value;

            if (!plate || !slot) {
                alert("الرجاء اختيار مركبة وإدخال رقم الموقف");
                return;
            }

            dailyEntries.push({ plate, client, unit, slot });
            alert(`تم تسجيل الدخول: ${plate}`);
            
            document.getElementById('targetPlate').value = '';
            document.getElementById('slotNumber').value = '';
            updateStats();
        }

        function updateStats() {
            const companyCounts = {};
            dailyEntries.forEach(e => companyCounts[e.client] = (companyCounts[e.client] || 0) + 1);

            const ctx = document.getElementById('companyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(companyCounts),
                    datasets: [{
                        label: 'عدد المركبات',
                        data: Object.values(companyCounts),
                        backgroundColor: '#0a84ff',
                        borderRadius: 10
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: { 
                        x: { ticks: { color: '#888' } },
                        y: { ticks: { color: '#888' }, grid: { color: 'rgba(128,128,128,0.1)' } }
                    }
                }
            });

            const unitStats = document.getElementById('parkingStats');
            const unitCounts = {};
            dailyEntries.forEach(e => unitCounts[e.unit] = (unitCounts[e.unit] || 0) + 1);
            
            const units = ['P1', 'P1-VIP', 'P2', 'P3', 'P4', 'Landscape'];
            unitStats.innerHTML = units.map(u => `
                <div class="stat-box">
                    <small>${u}</small>
                    <span>${unitCounts[u] || 0}</span>
                </div>
            `).join('');
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
        }

        function toggleView() {
            const ev = document.getElementById('entryView');
            const sv = document.getElementById('statsView');
            if (ev.style.display === 'none') {
                ev.style.display = 'block';
                sv.style.display = 'none';
            } else {
                ev.style.display = 'none';
                sv.style.display = 'block';
                updateStats();
            }
        }

        function exportReport() {
            const area = document.getElementById('exportArea');
            html2canvas(area, { 
                backgroundColor: document.body.classList.contains('dark') ? '#000000' : '#f2f2f7',
                scale: 2 
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Majdoul_Report_${new Date().toLocaleDateString()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        loadCSV();
    </script>
</body>
</html>
